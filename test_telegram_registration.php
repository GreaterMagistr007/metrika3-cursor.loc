<?php

require_once 'vendor/autoload.php';

// Load Laravel environment
$app = require_once 'bootstrap/app.php';
$app->make('Illuminate\Contracts\Console\Kernel')->bootstrap();

use App\Models\User;
use App\Services\AuthService;

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–µ—Ö–∞–Ω–∏–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram...\n\n";

// 1. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å Telegram ID
echo "1Ô∏è‚É£ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å Telegram ID...\n";
$user = User::create([
    'name' => 'Test Telegram User',
    'phone' => '+79998887755',
    'telegram_id' => 987654321,
    'phone_verified_at' => now(),
    'last_login_at' => now()
]);

echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω:\n";
echo "   üÜî ID: {$user->id}\n";
echo "   üë§ Name: {$user->name}\n";
echo "   üì± Phone: {$user->phone}\n";
echo "   ü§ñ Telegram ID: {$user->telegram_id}\n\n";

// 2. –¢–µ—Å—Ç–∏—Ä—É–µ–º API –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
echo "2Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...\n";

$testTelegramId = 987654321;
$testPhone = '+79998887766';

// –¢–µ—Å—Ç 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
echo "   –¢–µ—Å—Ç 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID {$testTelegramId} —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\n";
$existingUser = User::where('telegram_id', $testTelegramId)->first();
if ($existingUser) {
    echo "   ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω: {$existingUser->name}\n";
} else {
    echo "   ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω\n";
}

// –¢–µ—Å—Ç 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
echo "   –¢–µ—Å—Ç 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID 999999999 –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\n";
$nonExistingUser = User::where('telegram_id', 999999999)->first();
if (!$nonExistingUser) {
    echo "   ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω (–æ–∂–∏–¥–∞–µ–º–æ)\n";
} else {
    echo "   ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω (–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ)\n";
}

echo "\n";

// 3. –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏–º–µ–Ω–∏
echo "3Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–º–µ–Ω–∏...\n";

$testNames = [
    '–ò–≤–∞–Ω' => true,           // –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ä—É—Å—Å–∫–æ–µ –∏–º—è
    'John' => true,           // –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –∏–º—è
    '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤' => true,    // –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è —Å –ø—Ä–æ–±–µ–ª–æ–º
    'John Smith' => true,     // –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –∏–º—è —Å –ø—Ä–æ–±–µ–ª–æ–º
    '–ê' => false,             // –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ
    '–û—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–µ –∏–º—è –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –≤ —Ç—Ä–∏–¥—Ü–∞—Ç—å —Å–∏–º–≤–æ–ª–æ–≤' => false, // –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ
    '–ò–≤–∞–Ω123' => false,       // –°–æ–¥–µ—Ä–∂–∏—Ç —Ü–∏—Ñ—Ä—ã
    '–ò–≤–∞–Ω@–ü–µ—Ç—Ä–æ–≤' => false,   // –°–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã
    '' => false,              // –ü—É—Å—Ç–æ–µ
];

foreach ($testNames as $name => $expected) {
    $isValid = validateName($name);
    $status = $isValid === $expected ? '‚úÖ' : '‚ùå';
    echo "   {$status} '{$name}' - " . ($isValid ? '–≤–∞–ª–∏–¥–Ω–æ' : '–Ω–µ–≤–∞–ª–∏–¥–Ω–æ') . "\n";
}

echo "\n";

// 4. –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ç–µ–ª–µ—Ñ–æ–Ω–∞
echo "4Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞...\n";

$testPhones = [
    '+79998887766' => true,   // –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä
    '+7 (999) 888-77-66' => true, // –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä
    '+7999888776' => false,   // –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π
    '+799988877666' => false, // –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
    '79998887766' => false,   // –ë–µ–∑ +
    '+89998887766' => false,  // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã
    '+7999888776a' => false,  // –°–æ–¥–µ—Ä–∂–∏—Ç –±—É–∫–≤—ã
];

foreach ($testPhones as $phone => $expected) {
    $isValid = validatePhone($phone);
    $status = $isValid === $expected ? '‚úÖ' : '‚ùå';
    echo "   {$status} '{$phone}' - " . ($isValid ? '–≤–∞–ª–∏–¥–Ω–æ' : '–Ω–µ–≤–∞–ª–∏–¥–Ω–æ') . "\n";
}

echo "\n";

// 5. –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É OTP
echo "5Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ OTP...\n";

$authService = app(AuthService::class);
$otp = $authService->generateAndSendOtp($testPhone, $testTelegramId);

echo "   üîê –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π OTP: {$otp}\n";
echo "   ‚úÖ OTP –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ AuthService\n\n";

// 6. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
echo "6Ô∏è‚É£ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ:\n";
echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8000/telegram-register?telegram_id={$testTelegramId}\n";
echo "   2. –î–æ–ª–∂–Ω–∞ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)\n";
echo "   3. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8000/telegram-register?telegram_id=999999999\n";
echo "   4. –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è —Ñ–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)\n";
echo "   5. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é\n";
echo "   6. –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è\n\n";

echo "üéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!\n";

// –§—É–Ω–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
function validateName($name) {
    $trimmed = trim($name);
    
    if (empty($trimmed)) return false;
    if (strlen($trimmed) < 2) return false;
    if (strlen($trimmed) > 30) return false;
    
    // –¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–µ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –±—É–∫–≤—ã, –ø—Ä–æ–±–µ–ª—ã
    return preg_match('/^[–∞-—è—ë–ê-–Ø–Åa-zA-Z\s]+$/', $trimmed);
}

function validatePhone($phone) {
    // –û—á–∏—â–∞–µ–º –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    $cleaned = preg_replace('/[^\d+]/', '', $phone);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç +7XXXXXXXXXX
    return preg_match('/^\+7\d{10}$/', $cleaned);
}
