# Настройка Telegram Mini App

## Проблема
Telegram Bot не запускает Mini App автоматически. Нужно настроить бота для работы с Web App.

## Решение

### 1. Настройка бота через BotFather

1. **Откройте @BotFather в Telegram**
2. **Выберите вашего бота** `/mybots` → `M_150_site_bot`
3. **Настройте Mini App:**
   ```
   /newapp
   ```
4. **Выберите бота:** `M_150_site_bot`
5. **Введите название:** `Metrika3 Cabinet`
6. **Введите описание:** `Система управления кабинетами`
7. **Загрузите иконку** (опционально)
8. **Введите URL:** `http://localhost:8000/telegram-register`
9. **Введите короткое имя:** `metrika3-cabinet`

### 2. Альтернативный способ - через API

Запустите скрипт настройки:
```bash
php setup_telegram_simple.php
```

### 3. Тестирование

#### Способ 1: Через бота
1. Найдите бота @M_150_site_bot
2. Нажмите `/start`
3. Должна появиться кнопка "Открыть приложение"
4. Нажмите кнопку - Mini App должен открыться

#### Способ 2: Прямая ссылка
Откройте в браузере:
```
http://localhost:8000/telegram-register?telegram_id=123456789
```

#### Способ 3: Тестовая страница
Откройте:
```
http://localhost:8000/test_mini_app.html
```

### 4. Проверка работы

1. **Mini App должен:**
   - Открываться в Telegram
   - Получать данные пользователя автоматически
   - Проверять существование пользователя
   - Показывать форму регистрации для новых пользователей

2. **Если не работает:**
   - Проверьте, что сервер запущен: `php artisan serve`
   - Проверьте URL в настройках бота
   - Убедитесь, что бот настроен правильно

### 5. Отладка

#### Проверка настроек бота:
```bash
curl "https://api.telegram.org/bot7396908423:AAFk3WRot3sy_fpUnii1Up0-M5e8Z7PlbkA/getMe"
```

#### Проверка команд бота:
```bash
curl "https://api.telegram.org/bot7396908423:AAFk3WRot3sy_fpUnii1Up0-M5e8Z7PlbkA/getMyCommands"
```

#### Проверка Web App:
```bash
curl "https://api.telegram.org/bot7396908423:AAFk3WRot3sy_fpUnii1Up0-M5e8Z7PlbkA/getWebhookInfo"
```

### 6. Структура URL

- **Основная страница:** `http://localhost:8000/telegram-register`
- **С параметром:** `http://localhost:8000/telegram-register?telegram_id=123456789`
- **Тестовая страница:** `http://localhost:8000/test_mini_app.html`

### 7. Логика работы

1. **Пользователь нажимает кнопку в боте** → Открывается Mini App
2. **Mini App получает Telegram ID** → Проверяет существование пользователя
3. **Если пользователь существует** → Автоматическая авторизация
4. **Если не существует** → Форма регистрации
5. **После регистрации** → Автоматическая авторизация

## Примечания

- Mini App работает только в Telegram
- Для тестирования в браузере используйте URL с параметром `telegram_id`
- Убедитесь, что сервер доступен по указанному URL
